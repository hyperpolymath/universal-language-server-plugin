# Universal Language Connector - GitLab CI/CD Pipeline
# RSR-compliant continuous integration

variables:
  RUST_VERSION: "1.75"
  CARGO_HOME: "${CI_PROJECT_DIR}/.cargo"
  RUST_LOG: "info"

# Cache dependencies across jobs
.cache_template: &cache_definition
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - server/target/
      - ${CARGO_HOME}
      - clients/vscode/node_modules/

# Stages
stages:
  - validate
  - build
  - test
  - security
  - deploy
  - release

# Before script - install Rust
.rust_template: &rust_install
  before_script:
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${RUST_VERSION}
    - source $HOME/.cargo/env
    - rustc --version
    - cargo --version

# Validate RSR Compliance
rsr-compliance:
  stage: validate
  image: alpine:latest
  script:
    - apk add --no-cache bash just
    - just validate-rsr
  allow_failure: false
  artifacts:
    reports:
      junit: rsr-compliance-report.xml
    expire_in: 1 week

# Format check
format:
  stage: validate
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cd server
    - cargo fmt --check
  allow_failure: false

# Linting
clippy:
  stage: validate
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cd server
    - rustup component add clippy
    - cargo clippy -- -D warnings
  allow_failure: false

# Build debug
build-debug:
  stage: build
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cd server
    - cargo build
  artifacts:
    paths:
      - server/target/debug/universal-connector-server
    expire_in: 1 day

# Build release
build-release:
  stage: build
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cd server
    - cargo build --release
  artifacts:
    paths:
      - server/target/release/universal-connector-server
    expire_in: 1 week
  only:
    - main
    - tags

# Unit tests
test-unit:
  stage: test
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  dependencies:
    - build-debug
  script:
    - cd server
    - cargo test --lib -- --test-threads=1
  artifacts:
    reports:
      junit: server/target/junit.xml
    expire_in: 1 week

# Integration tests
test-integration:
  stage: test
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  dependencies:
    - build-debug
  script:
    - cd server
    - cargo test --test '*' -- --test-threads=1
  allow_failure: true  # Integration tests may require external services

# Code coverage
coverage:
  stage: test
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cargo install cargo-tarpaulin || true
    - cd server
    - cargo tarpaulin --out Xml --output-dir coverage
  coverage: '/\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: server/coverage/cobertura.xml
    paths:
      - server/coverage/
    expire_in: 1 week
  only:
    - main

# Security audit
security-audit:
  stage: security
  image: rust:${RUST_VERSION}
  <<: *rust_install
  script:
    - cargo install cargo-audit || true
    - cd server
    - cargo audit --deny warnings
  allow_failure: true  # Don't block on advisories initially
  only:
    - main
    - merge_requests

# Dependency check
dependency-check:
  stage: security
  image: rust:${RUST_VERSION}
  <<: *rust_install
  script:
    - cargo install cargo-outdated || true
    - cd server
    - cargo outdated --exit-code 1
  allow_failure: true
  only:
    - schedules

# SAST (Static Application Security Testing)
sast:
  stage: security
  image: rust:${RUST_VERSION}
  script:
    - echo "SAST scanning with cargo-geiger or similar"
    - cargo install cargo-geiger || true
    - cd server
    - cargo geiger || true
  allow_failure: true

# Build Docker image
docker-build:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -f deployment/Dockerfile -t universal-connector:${CI_COMMIT_SHORT_SHA} .
    - docker tag universal-connector:${CI_COMMIT_SHORT_SHA} universal-connector:latest
  only:
    - main
    - tags
  artifacts:
    paths:
      - universal-connector.tar
    expire_in: 1 week

# VS Code client build
vscode-client:
  stage: build
  image: node:20
  script:
    - cd clients/vscode
    - npm ci
    - npm run compile
  artifacts:
    paths:
      - clients/vscode/out/
    expire_in: 1 day
  cache:
    key: vscode-deps
    paths:
      - clients/vscode/node_modules/

# Documentation
docs:
  stage: build
  image: rust:${RUST_VERSION}
  <<: *rust_install
  script:
    - cd server
    - cargo doc --no-deps
  artifacts:
    paths:
      - server/target/doc/
    expire_in: 1 week
  only:
    - main

# Release binary (on tags)
release-binary:
  stage: release
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cd server
    - cargo build --release
    - strip target/release/universal-connector-server
    - tar czf universal-connector-${CI_COMMIT_TAG}-x86_64-linux.tar.gz -C target/release universal-connector-server
  artifacts:
    paths:
      - server/universal-connector-*.tar.gz
    expire_in: never
  only:
    - tags
  except:
    - branches

# Deploy to staging
deploy-staging:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploy to staging environment"
    - echo "Example: scp binary to staging server"
  environment:
    name: staging
    url: https://staging.universal-connector.org
  only:
    - main
  when: manual

# Deploy to production
deploy-production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploy to production environment"
    - echo "Example: scp binary to production server"
  environment:
    name: production
    url: https://universal-connector.org
  only:
    - tags
  when: manual

# Nightly builds
nightly:
  stage: build
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - cd server
    - cargo build --release
  only:
    - schedules
  artifacts:
    paths:
      - server/target/release/universal-connector-server
    expire_in: 7 days

# Performance benchmarks
benchmarks:
  stage: test
  image: rust:${RUST_VERSION}
  <<: *cache_definition
  <<: *rust_install
  script:
    - echo "Benchmarks not yet implemented"
    - echo "To add: uncomment criterion in Cargo.toml and implement benches/"
  allow_failure: true
  only:
    - main

# License compliance check
license-check:
  stage: validate
  image: rust:${RUST_VERSION}
  <<: *rust_install
  script:
    - cargo install cargo-license || true
    - cd server
    - cargo license --json
  allow_failure: true

# Check all clients compile
clients-check:
  stage: validate
  image: alpine:latest
  script:
    - apk add --no-cache bash
    - echo "Checking client LOC constraints..."
    - test $(wc -l < clients/vscode/extension.ts) -lt 100 || (echo "VS Code client exceeds 100 LOC" && exit 1)
    - test $(wc -l < clients/neovim/init.lua) -lt 100 || (echo "Neovim client exceeds 100 LOC" && exit 1)
    - test $(wc -l < clients/emacs/universal-connector.el) -lt 100 || (echo "Emacs client exceeds 100 LOC" && exit 1)
    - echo "âœ… All clients meet <100 LOC constraint"
  allow_failure: false

# Merge request pipeline
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
